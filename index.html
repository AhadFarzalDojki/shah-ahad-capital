<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shah & Ahad Capital â€“ Home</title>
  <style>
    /* All your existing CSS is here */
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0a0f16 0%, #111c2e 100%); color: #cbd5e1; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 0 15px 40px; animation: fadeIn 0.9s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: translateY(0);} }
    a { color: #00ffc8; text-decoration: none; font-weight: 600; transition: color 0.3s ease; }
    a:hover, a:focus { color: #14ffdf; outline: none; }
    nav.navbar { width: 100%; max-width: 980px; background: #111c2e; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,255,200,0.15); margin: 20px 0 30px; padding: 12px 0; display: flex; justify-content: center; gap: 30px; font-size: 1.15rem; user-select: none; }
    nav.navbar a { padding: 6px 10px; border-radius: 6px; }
    nav.navbar a:hover { background: #00ffc8; color: #111c2e; box-shadow: 0 0 10px #00ffc8aa; }
    #authButtons { margin: 0 auto 10px; max-width: 980px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    #authButtons input { padding: 8px 12px; border-radius: 6px; border: none; width: 220px; background: #1f2a40; color: #cbd5e1; font-size: 1rem; transition: background 0.3s ease; }
    #authButtons input::placeholder { color: #64748b; }
    #authButtons input:focus { outline: 2px solid #00ffc8; background: #0a192f; }
    #authButtons button { padding: 8px 16px; border-radius: 6px; border: none; background: #00ffc8; color: #111c2e; font-weight: 700; cursor: pointer; transition: background 0.3s ease; }
    #authButtons button:hover, #authButtons button:focus { background: #14ffdf; outline: none; }
    #userStatus { font-size: 0.9rem; margin-bottom: 25px; max-width: 980px; text-align: center; color: #94a3b8; user-select: none; }
    .hero { max-width: 900px; width: 100%; background: radial-gradient(circle at center, #1f2a40, #0a0f16); border-radius: 14px; box-shadow: 0 0 18px #00ffc888; padding: 60px 30px 50px; text-align: center; color: #00ffc8; user-select: none; margin-bottom: 40px; }
    .hero h1 { font-size: 3rem; margin-bottom: 15px; letter-spacing: 1.2px; }
    .hero p { font-size: 1.3rem; font-weight: 500; max-width: 720px; margin: 0 auto; line-height: 1.4; color: #cbd5e1cc; }
    .card-summary { max-width: 900px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background-color: #1a1a1a; border: 1px solid #333; border-radius: 14px; padding: 28px 20px; text-align: center; box-shadow: 0 8px 15px rgba(0, 255, 200, 0.12); transition: transform 0.25s ease, box-shadow 0.25s ease; user-select: none; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 15px 30px #00ffc8cc; }
    .card h3 { font-weight: 700; font-size: 1.2rem; margin-bottom: 12px; color: #00ffc8; }
    .card span { font-weight: 900; font-size: 1.7rem; color: #00ffc8; }
    .benchmark-summary { max-width: 900px; width: 100%; background: #111c2e; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,255,200,0.15); padding: 25px 30px; margin-bottom: 50px; text-align: center; }
    .benchmark-summary h2 { color: #00ffc8; margin-top: 0; margin-bottom: 20px; font-size: 1.5rem; }
    .benchmark-comparison { display: flex; justify-content: space-around; gap: 20px; flex-wrap: wrap; font-size: 1.1rem; }
    .benchmark-metric h4 { margin: 0 0 8px; color: #94a3b8; font-weight: 600; }
    .benchmark-metric span { font-size: 2rem; font-weight: 900; }
    table { width: 100%; max-width: 900px; border-collapse: collapse; margin: 30px auto 50px; color: #cbd5e1; user-select: none; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,255,200,0.15); }
    thead { background: #0a192f; user-select: none; }
    th, td { padding: 14px 12px; text-align: center; border-bottom: 1px solid #2a374a; font-size: 0.95rem; }
    tbody tr:nth-child(odd) { background: #111c2e; }
    tbody tr:hover { background: #00ffc833; }
    th { color: #00ffc8; font-weight: 700; letter-spacing: 0.04em; }
    button.action-btn { background: #00ffc8; color: #111c2e; border: none; border-radius: 8px; padding: 6px 14px; font-weight: 700; cursor: pointer; transition: background 0.3s ease; user-select: none; font-size: 0.9rem; }
    button.action-btn:hover, button.action-btn:focus { background: #14ffdf; outline: none; }
    #archiveAllBtn { background-color: #f59e0b; color: #111c2e; }
    #archiveAllBtn:hover { background-color: #facc15; }
    .profit { color: #4ade80; font-weight: 700; user-select: text; }
    .loss { color: #f87171; font-weight: 700; user-select: text; }
    #adminControls { max-width: 600px; margin: 0 auto 40px; padding: 22px 20px; background: #222c44; border-radius: 16px; box-shadow: 0 0 14px #00ffc8bb; color: #00ffc8; text-align: center; user-select: none; }
    #adminControls h3 { margin-top: 0; margin-bottom: 18px; font-weight: 800; font-size: 1.6rem; user-select: none; }
    #adminControls input { margin: 6px 10px 12px 0; padding: 10px 14px; border-radius: 10px; border: none; background: #15203a; color: #00ffc8; font-weight: 700; width: 110px; font-size: 1rem; transition: background 0.3s ease; user-select: text; }
    #adminControls input::placeholder { color: #4ade80cc; }
    #adminControls input:focus { background: #0a192f; outline: 2px solid #00ffc8; }
    #adminControls button { margin: 14px 6px 0; padding: 10px 20px; border-radius: 12px; border: none; background: #00ffc8; color: #111c2e; font-weight: 800; cursor: pointer; transition: background 0.3s ease; user-select: none; font-size: 1rem; }
    #adminControls button:hover, #adminControls button:focus { background: #14ffdf; outline: none; }
    .about-us { margin: 40px auto 50px; max-width: 880px; text-align: center; }
    .about-us h2 { font-size: 2rem; color: #00ffc8; margin-bottom: 18px; user-select: none; }
    .about-us p { font-size: 1.15rem; line-height: 1.6; color: #cbd5e1cc; user-select: text; }
    @media (max-width: 640px) { nav.navbar { gap: 15px; font-size: 1rem; } .hero h1 { font-size: 2.2rem; } .hero p { font-size: 1.1rem; } #adminControls input { width: 90px; margin-bottom: 8px; } #authButtons { flex-direction: column; gap: 12px; } #authButtons input { width: 100%; max-width: 300px; } }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html">Home</a><a href="Holdings & Archives.html">Holdings & Archives</a><a href="model.html">Model</a>
  </nav>

  <div id="authButtons"></div>
  <p id="userStatus">Checking login...</p>

  <section class="hero">
    <h1>Shah &amp; Ahad Capital</h1>
    <p>Track. Analyze. Win the Markets. This is our journey in building a smarter investment portfolio, powered by data, reasoning, and our own trading model.</p>
  </section>

  <section class="card-summary" id="portfolioSummary">
    <article class="card"><h3>Total Invested</h3><span id="totalInvested">$0.00</span></article>
    <article class="card"><h3>Total Value</h3><span id="totalValue">$0.00</span></article>
    <article class="card"><h3>Realized P/L</h3><span id="realizedPL">$0.00</span></article>
    <article class="card"><h3>Unrealized P/L</h3><span id="unrealizedPL">$0.00 (0.0%)</span></article>
  </section>
  
  <section class="benchmark-summary">
    <h2>Portfolio vs. Benchmark (S&P 500)</h2>
    <div class="benchmark-comparison">
        <div class="benchmark-metric"><h4>Our Return (Since Inception)</h4><span id="ourReturn">...</span></div>
        <div class="benchmark-metric"><h4>S&P 500 Return (Since Inception)</h4><span id="spyReturn">...</span></div>
    </div>
  </section>

  <section id="adminControls" style="display:none;">
    <h3>Admin Controls</h3>
    <input id="symbol" placeholder="Symbol" maxlength="5" /><input id="shares" type="number" placeholder="Shares" min="0" step="any" /><input id="price" type="number" placeholder="Price" min="0" step="any" /><input id="date" placeholder="Date (dd/mm/yyyy)" /><input id="reasoning" placeholder="Reasoning" /><br />
    <button onclick="addInvestment()">Add Investment</button>
    <button id="archiveAllBtn" onclick="archiveAllHoldings()">Archive All Holdings</button>
    <button onclick="clearAll()">Clear All Investments</button>
  </section>

  <table id="holdingsTable">
    <thead><tr><th>Symbol</th><th>Shares</th><th>Buy Price</th><th>Current Price</th><th>Value</th><th>P/L</th><th>Duration</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="realizedTable">
     <thead><tr><th>Symbol</th><th>Shares</th><th>Buy Price</th><th>Sell Price</th><th>Buy Date</th><th>Sell Date</th><th>Duration</th><th>P/L</th></tr></thead>
    <tbody></tbody>
  </table>

  <section class="about-us">
    <h2>About Us</h2>
    <p>We're Ahad and Shah, two student investors and rising seniors passionate about finance, trading, and learning by doing...</p>
  </section>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBmCJR5WMYqve41_n9LV8P1A1bbIw-bjQ4",
      authDomain: "tracker-b57d5.firebaseapp.com",
      databaseURL: "https://tracker-b57d5-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tracker-b57d5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    const alphaVantageApiKey = "NRJ2EH92QEDPAYHV";
    let isAdmin = false;

    const fmt = n => "$" + (Number(n) || 0).toFixed(2);
    const daysSince = dStr => dStr ? Math.floor((new Date() - new Date(dStr.split('/').reverse().join('-'))) / 864e5) : 0;
    const daysBetween = (s, e) => s && e ? Math.floor((new Date(e.split('/').reverse().join('-')) - new Date(s.split('/').reverse().join('-'))) / 864e5) : 0;
    const getQuarter = date => Math.floor(date.getMonth() / 3) + 1;

    // --- START: MODIFIED CODE ---
    // The fetchLivePrice function is now removed from the browser code.
    // We will now get prices directly from our database cache.
    const fetchHistoricalPrice = async (symbol, dateStr) => {
        let targetDate = new Date(dateStr.split('/').reverse().join('-'));
        for (let i = 0; i < 7; i++) {
            const formattedDate = targetDate.toISOString().split('T')[0];
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${alphaVantageApiKey}`;
            try {
                const r = await fetch(url);
                const d = await r.json();
                if (d["Time Series (Daily)"] && d["Time Series (Daily)"][formattedDate]) {
                    return parseFloat(d["Time Series (Daily)"][formattedDate]["4. close"]);
                }
            } catch (error) { console.error(`Failed to fetch historical price for ${symbol}`, error); }
            targetDate.setDate(targetDate.getDate() - 1);
        }
        return 0;
    };
    // --- END: MODIFIED CODE ---
    
    async function renderPage(investments, realizedTrades, priceCache) {
        document.getElementById("adminControls").style.display = isAdmin ? "block" : "none";
        
        let totalInvested = 0, totalValue = 0;
        for (const inv of Object.values(investments)) {
            totalInvested += inv.shares * inv.price;
            totalValue += inv.shares * (priceCache[inv.symbol] || 0); // Use the cache
        }
        
        const unrealizedPL = totalValue - totalInvested;
        const realizedPL = Object.values(realizedTrades).reduce((sum, trade) => sum + (trade.pl || 0), 0);
        const unrealizedPct = totalInvested > 0 ? (unrealizedPL / totalInvested) * 100 : 0;
        document.getElementById("totalInvested").textContent = fmt(totalInvested);
        document.getElementById("totalValue").textContent = fmt(totalValue);
        document.getElementById("realizedPL").textContent = fmt(realizedPL);
        const unrealizedPLSpan = document.getElementById("unrealizedPL");
        unrealizedPLSpan.textContent = `${fmt(unrealizedPL)} (${unrealizedPct.toFixed(1)}%)`;
        unrealizedPLSpan.className = unrealizedPL >= 0 ? "profit" : "loss";

        // Render Benchmark
        const ourReturnEl = document.getElementById('ourReturn');
        const spyReturnEl = document.getElementById('spyReturn');
        ourReturnEl.textContent = "..."; spyReturnEl.textContent = "...";
        if (Object.keys(investments).length > 0) {
            const earliestDateStr = Object.values(investments).map(inv => new Date(inv.date.split('/').reverse().join('-'))).reduce((a, b) => a < b ? a : b).toLocaleDateString('en-GB');
            const [spyStartPrice, spyCurrentPrice] = await Promise.all([fetchHistoricalPrice('SPY', earliestDateStr), priceCache['SPY'] || 0]);
            if(spyStartPrice > 0 && spyCurrentPrice > 0) {
                const ourReturnPct = (totalValue - totalInvested) / totalInvested * 100;
                const spyReturnPct = (spyCurrentPrice - spyStartPrice) / spyStartPrice * 100;
                ourReturnEl.textContent = `${ourReturnPct.toFixed(2)}%`;
                ourReturnEl.className = ourReturnPct >= 0 ? 'profit' : 'loss';
                spyReturnEl.textContent = `${spyReturnPct.toFixed(2)}%`;
                spyReturnEl.className = spyReturnPct >= 0 ? 'profit' : 'loss';
            }
        }
        
        // Render Tables
        const holdingsTbody = document.querySelector("#holdingsTable tbody");
        holdingsTbody.innerHTML = Object.keys(investments).length === 0 ? `<tr><td colspan="8" style="color:#64748b;">No current holdings</td></tr>` : Object.entries(investments).map(([id, inv]) => {
            const currentPrice = priceCache[inv.symbol] || 0, value = currentPrice * inv.shares, pl = value - (inv.shares * inv.price);
            return `<tr><td>${inv.symbol}</td><td>${inv.shares}</td><td>${fmt(inv.price)}</td><td>${fmt(currentPrice)}</td><td>${fmt(value)}</td><td class="${pl >= 0 ? 'profit' : 'loss'}">${fmt(pl)}</td><td>${daysSince(inv.date)} days</td><td>${isAdmin ? `<button class="action-btn" onclick="deleteInvestment('${id}')">Delete</button>` : ''}</td></tr>`;
        }).join('');
        const realizedTbody = document.querySelector("#realizedTable tbody");
        realizedTbody.innerHTML = Object.keys(realizedTrades).length === 0 ? `<tr><td colspan="8" style="color:#64748b;">No realized trades</td></tr>` : Object.values(realizedTrades).map(trade => {
            return `<tr><td>${trade.symbol}</td><td>${trade.shares}</td><td>${fmt(trade.buyPrice)}</td><td>${fmt(trade.sellPrice)}</td><td>${trade.buyDate}</td><td>${trade.sellDate}</td><td>${daysBetween(trade.buyDate, trade.sellDate)} days</td><td class="${trade.pl >= 0 ? 'profit' : 'loss'}">${fmt(trade.pl)}</td></tr>`;
        }).join('');
    }

    window.login = () => auth.signInWithEmailAndPassword(document.getElementById("loginEmail").value, document.getElementById("loginPass").value).catch(e => alert(e.message));
    window.logout = () => auth.signOut();
    window.addInvestment = () => { /* ... unchanged ... */ };
    window.deleteInvestment = (id) => { /* ... unchanged ... */ };
    window.clearAll = () => { /* ... unchanged ... */ };
    window.archiveAllHoldings = async () => { /* ... unchanged ... */ };
    
    auth.onAuthStateChanged(async user => {
        const authButtons = document.getElementById("authButtons");
        const userStatus = document.getElementById("userStatus");
        if (user) {
            const roleSnap = await db.ref(`roles/${user.uid}`).once("value");
            isAdmin = roleSnap.val() === "admin";
            authButtons.innerHTML = `Logged in as <strong>${user.email}</strong>${isAdmin ? " (Admin)" : ""}<button onclick="logout()">Logout</button>`;
            userStatus.textContent = `Welcome, ${user.email}`;
        } else {
            isAdmin = false;
            authButtons.innerHTML = `<input id="loginEmail" type="email" placeholder="Email" /><input id="loginPass" type="password" placeholder="Password" /><button onclick="login()">Login</button>`;
            userStatus.textContent = "Please log in to manage your portfolio.";
        }
        const [invSnap, realSnap, priceSnap] = await Promise.all([db.ref("investments").once("value"), db.ref("realized").once("value"), db.ref("priceCache").once("value")]);
        renderPage(invSnap.val() || {}, realSnap.val() || {}, priceSnap.val() || {});
    });

    // The rest of your functions remain the same...
    db.ref().on('value', async () => {
        const [invSnap, realSnap, priceSnap] = await Promise.all([db.ref("investments").once("value"), db.ref("realized").once("value"), db.ref("priceCache").once("value")]);
        renderPage(invSnap.val() || {}, realSnap.val() || {}, priceSnap.val() || {});
    });
  </script>
</body>
</html>